<html>
    <head>
        <meta charset="utf-8">
        <title>Battista</title>
        <link href='http://fonts.googleapis.com/css?family=Buenard' rel='stylesheet' type='text/css'>
        <style>
            canvas { border: 1px solid black; }
        </style>
    </head>
    <body onload="main()"">
        <form id="registration">
            <input type="text" id = "username"></input>
            <input type="submit"></input>
        </form>
        <div>
            <canvas id="game"></canvas>
        </div>
        <div id="game"></div>
        <!-- TODO: Figure out how to link to this. -->
        <!--<p><a href="getting-started.html" target="_blank">How to Play</a></p>-->
    </body>
    <script type="application/javascript">
        let discoveredRooms = [];
        let width;
        let height;
        let roomSize = 25;
        let wallWidth = roomSize/10;
        let player_position;
        let user_id;
        let other_players = {};

        let edgeTypes = {
            WALL: "Wall",
            PASSAGE: "Passage",
        }

        function main(){
            document.getElementById('registration').addEventListener('submit', e => {
                let username = document.getElementById('username').value;
                console.log(username);
                submit(username);
                e.preventDefault();
            })
        }

        function submit(username){
            registerUser(username)
            .then(data => {
                height = data.height;
                width = data.width;

                let canvas = document.getElementById('game');
                // canvas.height = wallWidth + (height * (roomSize + wallWidth));
                canvas.height = height * roomSize;
                // canvas.width = wallWidth + (width * (roomSize + wallWidth));
                canvas.width = width * roomSize;

                console.log(`User id 1 registered with websocket uuid: ${data.id}`);

                playerPosition = data.player_position;
                for (const property in data.explored_cells){
                    discoveredRooms[property] = data.explored_cells[property]
                }

                render();

                let move_id;

                const socket = new WebSocket(data.url);
                socket.addEventListener('message', data =>{
                    console.log(`Received: ${data.data}`);
                    data = JSON.parse(data.data);
                    // TODO: Add response types
                    if (data.move_id && data.player_id == user_id) {
                        playerPosition = data.player_position;
                        discoveredRooms[getIndexFromCoords(data.player_position)] = data.cell;
                        move_id = null;
                    } else {
                        discoveredRooms[getIndexFromCoords(data.player_position)] = data.cell;
                        other_players[data.player_id] = data.player_position;
                    }
                    render();
                })
                

                function keyHandler(e) {
                    var handled = false;
                    if (e.key !== undefined) {
                        handled = true;

                        if(e.key == "Right" || e.key == "ArrowRight" || e.key == "d") {
                            move_id = 2;
                            socket.send(JSON.stringify({
                                input: "e",
                            }))
                        }
                        if(e.key == "Left" || e.key == "ArrowLeft" || e.key == "a") {
                            move_id = 2;
                            socket.send(JSON.stringify({
                                input: "w",
                            }))
                        }
                        if(e.key == "Up" || e.key == "ArrowUp" || e.key == "w") {
                            move_id = 2;
                            socket.send(JSON.stringify({
                                input: "n",
                            }))
                        }
                        if(e.key == "Down" || e.key == "ArrowDown" || e.key == "s") {
                            move_id = 2;
                            socket.send(JSON.stringify({
                                input: "s",
                            }))
                        }
                        if (e.key == "r") {
                            resetHouse();
                        }

                    }

                    if (handled) {
                        event.preventDefault();
                    }

                }

                document.addEventListener("keydown", keyHandler, false);
            })
        }

        function getIndexFromCoords(coords) {
            return coords.y * width + coords.x;
        }

        async function registerUser(username){
            user_id = username.hashCode();
            const registerUrl = 'http://localhost:8000/register';

            const headers = new Headers({
                'Content-Type': 'application/json'
            })
            const response = await fetch(registerUrl, {
                method: 'POST',
                headers: headers,
                body: JSON.stringify({user_id: user_id})
            });
            return response.json();
        }

        String.prototype.hashCode = function() {
            var hash = 0, i, chr;
            if (this.length === 0) return hash;
            for (i = 0; i < this.length; i++) {
                chr   = this.charCodeAt(i);
                hash  = ((hash << 5) - hash) + chr;
                hash |= 0; // Convert to 32bit integer
                hash = hash >>> 0;
            }
            return hash;
        };

        // Rendering
        const canvas = document.getElementById('game')
        var ctx = canvas.getContext('2d');


        function getCoordsFromIndex(i){
            let y;
            if (i < width) {
                y = 0
                x = i;
            } else {
                y = Math.floor(i/width)
                x = i % (width * y);
            }
            return [x, y];
        } 

        async function render(){
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            for (let i = 0; i < discoveredRooms.length; ++i) {
                if (discoveredRooms[i] != null){
                    drawRoom(i);
                }
            }

            for (let i = 0; i < discoveredRooms.length; ++i) {
                if (discoveredRooms[i] != null){
                    drawWalls(i);
                }
            }

            drawPlayer();
            drawOtherPlayers();
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function drawRoom(i){
            let coords = getCoordsFromIndex(i);
            let x = coords[0];
            let y = coords[1];

            let leftX = x * roomSize;
            let rightX = (x * roomSize) + roomSize;
            let topY = y * roomSize;
            let bottomY = (y * roomSize) + roomSize;
            color = discoveredRooms[i].color;

            ctx.beginPath();
            ctx.fillStyle = color;
            ctx.fillRect(
                leftX,
                topY,
                roomSize,
                roomSize
            );
            ctx.stroke();
        }

        function drawWalls(i){
            let coords = getCoordsFromIndex(i);
            let x = coords[0];
            let y = coords[1];

            let leftX = x * roomSize;
            let rightX = (x * roomSize) + roomSize;
            let topY = y * roomSize;
            let bottomY = (y * roomSize) + roomSize;
            cell = discoveredRooms[i];

            ctx.lineWidth=wallWidth;

            ctx.beginPath()
            ctx.strokeStyle = "black";
            if (cell.edges.North == edgeTypes.WALL) {
                ctx.moveTo(leftX, topY);
                ctx.lineTo(rightX, topY);
            };

            if (cell.edges.East == edgeTypes.WALL) {
                ctx.moveTo(rightX, topY);
                ctx.lineTo(rightX, bottomY);
            };

            if (cell.edges.South == edgeTypes.WALL) {
                ctx.moveTo(rightX, bottomY);
                ctx.lineTo(leftX, bottomY);
            };

            if (cell.edges.West == edgeTypes.WALL) {
                ctx.moveTo(leftX, bottomY);
                ctx.lineTo(leftX, topY);
            };

            ctx.stroke();
        }

        function drawPlayer() {
            let x = playerPosition.x;
            let y = playerPosition.y;

            let leftX = x * roomSize;
            let rightX = (x * roomSize) + roomSize;
            let topY = y * roomSize;
            let bottomY = (y * roomSize) + roomSize;

            // adjust
            let shrink = roomSize/10
            leftX += shrink;
            topY += shrink;
            color = "blue";

            ctx.beginPath();
            ctx.fillStyle = color;
            ctx.fillRect(
                leftX,
                topY,
                roomSize - shrink * 2,
                roomSize - shrink * 2,
            );
            ctx.stroke();
        }

        function drawOtherPlayers() {
            for (const property in other_players) {
                let x = other_players[property].x;
                let y = other_players[property].y;

                let leftX = x * roomSize;
                let rightX = (x * roomSize) + roomSize;
                let topY = y * roomSize;
                let bottomY = (y * roomSize) + roomSize;

                // adjust
                let shrink = roomSize/10
                leftX += shrink;
                topY += shrink;
                color = "black";

                ctx.beginPath();
                ctx.fillStyle = color;
                ctx.fillRect(
                    leftX,
                    topY,
                    roomSize - shrink * 2,
                    roomSize - shrink * 2,
                );
                ctx.stroke();
            }
        }

    </script>
</html>
    